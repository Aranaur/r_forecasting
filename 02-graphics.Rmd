# Часові ряди та їх візуалізація {#ts}
***
```{r setup-02, echo = FALSE, purl = FALSE, cache = FALSE, include=FALSE}
knitr::opts_knit$set(global.par = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, collapse = TRUE, out.width = '100%')
library(fpp3)
library(tidyverse)
library(gapminder)
```

## Об'єкт `tsibble` {#ts_tsibble}
В мові програмування R є широкий спектр класів, за допомогою яких можна представити часові ряди: `ts`, `zoo` або `xts`. Але всі вони випадають з філософії "*tiny-data*", що призводить до складнощів їх використання з сімейством пакетів `tidyverse`.

Рішенням цієї задачі займалися ряд вчених на чолі з професором кафедри економетрики та бізнес статистика університету Монаша [Робом Хідманом](https://robjhyndman.com/). Вони розробили новий формат представлення часових рядів, який реалізований в пакеті `tsibble` [@hyndman_tibble]. Згідно цього формату, часові ряди:

- зберігаються в табличному вигляді;

- містять в собі мінімум два стовпчики: значення кількісної змінної впорядкованої в часі (*measurements*) та часова шкала (*index*) --- в який момент часу значення були записані;

- може містити декілька часових рядів, які згруповані за ключовим змінними (*key*).

Для створення об'єкту `tsibble` використовується функція `tsibble()`:
```{r}
tsibble(year = 2017:2021,
        variable = sample(c(50:100), 5),
        index = year)
```

Для перетворення дата фрейму в `tsibble` використовується функція `as_tsibble()`, яка містить наступні аргументи:

- `x` --- об'єкт даних (це може бути вектор, матриця, дата фрейм тощо);

- `key` --- групуюча змінна(і), яка(і) визначають кожен часовий ряд в даних;

- `index`  --- змінна з мітками часу;

- `regular` --- логічний аргумент, який вказує на регулярність (`TRUE`) або нерегулярність (`FALSE`) спостережень в даних;

- `validate` --- логічний аргумент, який перевіряє (`TRUE`) унікальність кожного спостереження в парах значень `key` та `index`;

- `.drop` --- логічний аргумент, якщо вказати `TRUE` з таблиці будуть виключені спостереження, для яких не має групуючого значення `key`;

- `tz` --- вказується часовий пояс спостережень;

- `pivot_longer` --- логічний аргумент, `TRUE` переводить дані в широкий формат, `FALSE` залишає як є.

Перетворемо базовий часовий ряд `AirPassengers` з `ts` в `tsibble`:
```{r}
class(AirPassengers)

AirPassengers %>% 
  as_tsibble()
```
Бачимо, що набір даних містить 144 щомісячних (`1M`) спостереження.

Розглянемо приклад перетворення дата фрейму `gapminder` у `tsibble`:
```{r}
gapminder %>% 
  as_tsibble(key = c(country, continent),
             index = year)
```
В даному випадку, ми отримали `tsibble`, який містить дві групуючі змінні та річні дані з інтвервалом у 5 років (`5Y`).

```{r}
gapminder %>% 
  as_tsibble(key = c(country, continent),
             index = year) %>% 
  autoplot(.vars = lifeExp) + 
  theme(legend.position="none")
```



