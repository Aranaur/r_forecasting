---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Часові ряди та їх візуалізація {#ts}
***
```{r setup-02, purl = FALSE, cache = TRUE, include=FALSE}
knitr::opts_knit$set(global.par = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, collapse = TRUE, out.width = '100%')
library(fpp3)
library(tsibble)
library(tidyverse)
library(gapminder)
library(vroom)
```
**Часовий ряд** --- це послідовність значень деякої змінної, що зареєстровані в певні моменти часу.

Розрізняють *одновимірні* та *багатовимірні* часові ряди. В першому випадку розглядається тільки одна змінна, в другому --- декілька паралельних спостережень.

Часовий ряди можна записати, як $y_t$, читається:  часовий ряд $y$ в момент часу $t$.

В загальному випадку часовий ряд $y_t$ розкладають на складові або *компоненти*:

- тренд ($T_t$) --- відповідає за довгострокову тенденцію зміни значень ряду (зростання, спадання, стагнація). Він може бути лінійним або нелінійним.

- сезонна компонента ($S_t$) --- відповідає за коливання часового ряду, які повторюються з постійною частотою. В цілому, якщо частота ряду щотижнева, щомісячна або щоквартальна і менше, вона може відображати сезонні коливання, тоді як для щорічних даних сезонність визначити неможливо.

- циклічна компонента ($C_t$) --- відповідає за довгострокові коливання ряду з непостійною регулярністю. Циклічні коливання охоплюють багаторічні періоди. Наприклад, це може бути пов'язано зі станом економіки країни (криза, спад, депресія тощо).

- випадкова компонента ($R_t$) --- стохастичні значення часового ряду, які неможливо врахувати.



## Об'єкт `tsibble` {#ts_tsibble}
В мові програмування R є широкий спектр класів, за допомогою яких можна представити часові ряди: `ts`, `zoo` або `xts`. Але всі вони випадають з філософії "*tiny-data*", що призводить до складнощів їх використання з сімейством пакетів `tidyverse`.

Рішенням цієї задачі займалися ряд вчених на чолі з професором кафедри економетрики та бізнес статистика університету Монаша [Робом Хідманом](https://robjhyndman.com/). Вони розробили новий формат представлення часових рядів, який реалізований в пакеті `tsibble` [@hyndman_tibble]. Згідно цього формату, часові ряди:

- зберігаються в табличному вигляді;

- містять в собі мінімум два стовпчики: значення кількісної змінної впорядкованої в часі (*measurements*) та часова шкала (*index*) --- в який момент часу значення були записані;

- може містити декілька часових рядів, які згруповані за ключовим змінними (*key*).

Для створення об'єкту `tsibble` використовується функція `tsibble()`:
```{r}
tsibble(year = 2017:2021,
        variable = sample(c(50:100), 5),
        index = year)
```

Для перетворення дата фрейму в `tsibble` використовується функція `as_tsibble()`, яка містить наступні аргументи:

- `x` --- об'єкт даних (це може бути вектор, матриця, дата фрейм тощо);

- `key` --- групуюча змінна(і), яка(і) визначають кожен часовий ряд в даних;

- `index`  --- змінна з мітками часу;

- `regular` --- логічний аргумент, який вказує на регулярність (`TRUE`) або нерегулярність (`FALSE`) спостережень в даних;

- `validate` --- логічний аргумент, який перевіряє (`TRUE`) унікальність кожного спостереження в парах значень `key` та `index`;

- `.drop` --- логічний аргумент, якщо вказати `TRUE` з таблиці будуть виключені спостереження, для яких не має групуючого значення `key`;

- `tz` --- вказується часовий пояс спостережень;

- `pivot_longer` --- логічний аргумент, `TRUE` переводить дані в широкий формат, `FALSE` залишає як є.

Перетворемо базовий часовий ряд `AirPassengers` з `ts` в `tsibble`:
```{r}
class(AirPassengers)

AirPassengers %>% 
  as_tsibble()
```
Бачимо, що набір даних містить 144 щомісячних (`1M`) спостереження.

Розглянемо приклад перетворення дата фрейму `gapminder` у `tsibble`:
```{r}
gapminder %>% 
  as_tsibble(key = c(country, continent),
             index = year)
```
В даному випадку, ми отримали `tsibble`, який містить дві ключові змінні та річні дані з інтервалом у 5 років (`5Y`).

Або подивимось на датасет з генерації відновлювальної електроенергії в Україні у 2021 році:
```{r}
ua_energy <- vroom("https://git.io/J6Sjt", delim = ";") %>% 
  mutate(Time = parse_date_time(Time, orders = "H-dmy")) %>% 
  as_tsibble(index = Time)

ua_energy
```


## Пропущенні значення {#ts_gaps}
При обробці непідготовлених даних досить часто зустріємося із ситуацією пропущених даних. Ця проблема особливо впливає на ефективність моделей прогнозування часових рядів.

Для перевірки наявності пропущених значень використовується функція `has_gaps()`:
```{r}
gapminder %>% 
  as_tsibble(key = c(country, continent),
             index = year) %>% 
  has_gaps()
```




```{r}
gapminder %>% 
  as_tsibble(key = c(country, continent),
             index = year) %>% 
  autoplot(.vars = lifeExp) + 
  theme(legend.position="none")
```



